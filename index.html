<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseBuilder - Radiopaedia Style Guide Compliant</title>
    
    <!-- [Keep existing styles...] -->
    
    <style>
        /* Add new styles for split demographics */
        .demographics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
        
        .style-warning {
            background: #fff3cd;
            color: #856404;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .style-success {
            background: #d4edda;
            color: #155724;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 0.25rem;
            display: none;
        }
    </style>
</head>
<body>
    <!-- [Keep header...] -->
    
    <div class="container">
        <div class="sidebar">
            <!-- Update sidebar to show Radiopaedia compliance -->
            <div class="section-title">üìä Radiopaedia Compliance</div>
            <div style="font-size: 0.85rem; color: var(--success);">
                <div id="complianceTitle">‚ö†Ô∏è Title case check</div>
                <div id="complianceAge">‚ö†Ô∏è Age rounding (18+)</div>
                <div id="compliancePresentation">‚ö†Ô∏è Presentation length</div>
                <div id="complianceFindings">‚ö†Ô∏è No modality in findings</div>
                <div id="complianceDiscussion">‚ö†Ô∏è Discussion completeness</div>
            </div>
            
            <!-- [Keep existing sidebar content...] -->
        </div>
        
        <div class="main-panel">
            <div class="section-title">üìù Case Details - Radiopaedia Style Guide v2</div>
            
            <!-- FIXED: Title with sentence case enforcement -->
            <div class="form-group">
                <label class="form-label">Case Title * <span style="color: var(--warning); font-size: 0.85rem;">(Must be sentence case)</span></label>
                <input type="text" class="form-input" id="caseTitle" 
                       placeholder="e.g., Subarachnoid hemorrhage in middle-aged patient" 
                       oninput="enforceSentenceCase(this); autoSave(); updateProgress()">
                <div class="style-warning" id="titleWarning">‚ö†Ô∏è Title should be in sentence case (only first letter capitalized)</div>
                <div class="char-count"><span id="titleCount">0</span>/100</div>
            </div>
            
            <!-- FIXED: Split demographics fields -->
            <div class="form-group">
                <label class="form-label">Patient Demographics</label>
                <div class="demographics-grid">
                    <div>
                        <input type="number" class="form-input" id="patientAge" 
                               placeholder="Age" 
                               oninput="handleAgeInput(this); autoSave()">
                        <small style="color: var(--text-light);">Auto-rounds to 5 years for 18+</small>
                    </div>
                    <div>
                        <select class="form-input" id="patientSex" onchange="autoSave()">
                            <option value="">Select sex</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div>
                        <input type="text" class="form-input" id="patientOther" 
                               placeholder="Other relevant info" 
                               oninput="autoSave()">
                    </div>
                </div>
                <div class="style-success" id="ageSuccess">‚úì Age rounded appropriately for privacy</div>
            </div>
            
            <!-- FIXED: Short presentation without vitals -->
            <div class="form-group">
                <label class="form-label">Patient Presentation * <span style="color: var(--success); font-size: 0.85rem;">(Brief, no vitals needed)</span></label>
                <div class="quick-insert">
                    <button class="quick-btn" onclick="insertText('presentation', 'Acute onset of symptoms')">Acute</button>
                    <button class="quick-btn" onclick="insertText('presentation', 'Gradual onset over days')">Gradual</button>
                    <button class="quick-btn" onclick="insertText('presentation', 'Incidental finding')">Incidental</button>
                </div>
                <textarea class="form-textarea" id="presentation" 
                          placeholder="Brief clinical presentation (1-2 sentences). Example: Sudden onset severe headache with photophobia and neck stiffness." 
                          oninput="checkPresentationLength(); autoSave(); updateProgress()"
                          maxlength="500"></textarea>
                <div class="char-count"><span id="presentationCount">0</span>/500</div>
                <div class="style-warning" id="presentationWarning">‚ö†Ô∏è Presentation should be brief (under 100 words)</div>
            </div>
            
            <!-- FIXED: Findings without modality -->
            <div class="form-group">
                <label class="form-label">Imaging Findings * <span style="color: var(--warning); font-size: 0.85rem;">(Don't mention modality - it's in the images)</span></label>
                <textarea class="form-textarea" id="findings" 
                          placeholder="Describe key findings without mentioning CT/MRI/etc. Example: Hyperdense material in the basal cisterns..." 
                          oninput="checkModalityMentions(); autoSave(); updateProgress()"></textarea>
                <div class="style-warning" id="findingsWarning">‚ö†Ô∏è Remove modality mentions (CT, MRI, etc.) - these are shown in the images</div>
            </div>
            
            <!-- FIXED: Renamed to Discussion -->
            <div class="form-group">
                <label class="form-label">Case Discussion <span style="color: var(--success); font-size: 0.85rem;">(Includes diagnosis discussion and teaching points)</span></label>
                <textarea class="form-textarea" id="discussion" 
                          placeholder="Discuss the diagnosis, relevant features of this case, differential considerations, and key teaching points..." 
                          oninput="autoSave(); updateProgress()"></textarea>
                <small style="color: var(--text-light);">This replaces the traditional 'Teaching Points' section per Radiopaedia style guide</small>
            </div>
            
            <!-- Add diagnostic certainty selector -->
            <div class="form-group">
                <label class="form-label">Diagnostic Certainty * <span style="color: var(--danger); font-size: 0.85rem;">(Required for publication)</span></label>
                <select class="form-input" id="certainty" onchange="autoSave()">
                    <option value="">Select certainty level</option>
                    <option value="certain">Certain</option>
                    <option value="almost_certain">Almost certain</option>
                    <option value="probable">Probable (unlisted cases only)</option>
                    <option value="possible">Possible (draft only)</option>
                </select>
                <small style="color: var(--text-light);">Public cases require "Certain" or "Almost certain"</small>
            </div>
            
            <!-- [Keep existing action buttons...] -->
        </div>
        
        <!-- [Keep AI panel...] -->
    </div>
    
    <script>
        // RADIOPAEDIA STYLE GUIDE COMPLIANCE FUNCTIONS
        
        // Enforce sentence case on title
        function enforceSentenceCase(input) {
            const original = input.value;
            const sentenceCase = toSentenceCase(original);
            
            // Check if it's already in sentence case
            if (original !== sentenceCase && original.length > 0) {
                document.getElementById('titleWarning').style.display = 'block';
                document.getElementById('complianceTitle').innerHTML = '‚ùå Fix title case';
            } else {
                document.getElementById('titleWarning').style.display = 'none';
                document.getElementById('complianceTitle').innerHTML = '‚úÖ Title case correct';
            }
        }
        
        function toSentenceCase(str) {
            if (!str) return '';
            
            // Medical abbreviations to preserve
            const preserveWords = ['CT', 'MRI', 'MRA', 'CTA', 'US', 'PET', 'SPECT', 'FLAIR', 'DWI', 'ADC', 'T1', 'T2',
                                 'SAH', 'SDH', 'EDH', 'ICH', 'IVH', 'GBM', 'AVM', 'CVA', 'TIA', 'MS', 'ALS',
                                 'COPD', 'PE', 'DVT', 'ARDS', 'MI', 'CHF', 'AAA', 'SBO', 'LBO', 'IBD', 'HCC', 'RCC'];
            
            // First, lowercase everything except first letter
            let result = str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
            
            // Restore medical abbreviations
            preserveWords.forEach(word => {
                const regex = new RegExp('\\b' + word.toLowerCase() + '\\b', 'gi');
                result = result.replace(regex, word);
            });
            
            return result;
        }
        
        // Handle age input with rounding
        function handleAgeInput(input) {
            const age = parseInt(input.value);
            if (isNaN(age)) return;
            
            if (age >= 18) {
                const rounded = Math.round(age / 5) * 5;
                if (age !== rounded) {
                    document.getElementById('ageSuccess').style.display = 'block';
                    document.getElementById('ageSuccess').innerHTML = `‚úì Age will be displayed as ${rounded} years (rounded from ${age})`;
                    document.getElementById('complianceAge').innerHTML = '‚úÖ Age rounded';
                }
            } else {
                document.getElementById('ageSuccess').style.display = 'none';
                document.getElementById('complianceAge').innerHTML = '‚úÖ Pediatric age';
            }
        }
        
        // Check presentation length
        function checkPresentationLength() {
            const text = document.getElementById('presentation').value;
            const wordCount = text.trim().split(/\s+/).filter(w => w.length > 0).length;
            
            if (wordCount > 100) {
                document.getElementById('presentationWarning').style.display = 'block';
                document.getElementById('compliancePresentation').innerHTML = '‚ùå Too long';
            } else if (wordCount > 0) {
                document.getElementById('presentationWarning').style.display = 'none';
                document.getElementById('compliancePresentation').innerHTML = '‚úÖ Brief presentation';
            }
            
            // Check for vitals and warn
            if (text.includes('BP:') || text.includes('HR:') || text.includes('vital')) {
                document.getElementById('presentationWarning').style.display = 'block';
                document.getElementById('presentationWarning').innerHTML = '‚ö†Ô∏è Vitals are not typically included in Radiopaedia presentations';
            }
        }
        
        // Check for modality mentions in findings
        function checkModalityMentions() {
            const findings = document.getElementById('findings').value.toLowerCase();
            const modalities = ['ct ', 'mri ', 'x-ray', 'xray', 'ultrasound', 'pet ', 'spect', 'computed tomography', 'magnetic resonance'];
            
            let hasModality = false;
            modalities.forEach(modality => {
                if (findings.includes(modality)) {
                    hasModality = true;
                }
            });
            
            if (hasModality) {
                document.getElementById('findingsWarning').style.display = 'block';
                document.getElementById('complianceFindings').innerHTML = '‚ùå Remove modality';
            } else if (findings.length > 10) {
                document.getElementById('findingsWarning').style.display = 'none';
                document.getElementById('complianceFindings').innerHTML = '‚úÖ No modality mentions';
            }
        }
        
        // Updated templates without vitals
        const templates = {
            emergency: {
                title: 'Acute presentation with concerning findings',
                age: '45',
                sex: 'Male',
                presentation: 'Sudden onset severe headache with photophobia and neck stiffness.',
                findings: 'Hyperdense material in the basal cisterns and sulci. No hydrocephalus or midline shift.',
                discussion: 'This case demonstrates classic findings of subarachnoid hemorrhage. The distribution pattern suggests aneurysmal origin. Key teaching points include recognition of hyperdense blood in CSF spaces and the importance of urgent vascular imaging.',
                certainty: 'certain'
            },
            chronic: {
                title: 'Follow-up examination showing disease progression',
                age: '60',
                sex: 'Female',
                presentation: 'Known history of multiple sclerosis, presenting with new visual symptoms.',
                findings: 'Multiple periventricular hyperintense lesions. New enhancing lesion in the right optic nerve.',
                discussion: 'This case illustrates typical progression of demyelinating disease. The new enhancing lesion correlates with clinical symptoms. Important to compare with prior studies to identify new lesions.',
                certainty: 'certain'
            }
        };
        
        // Export function update - format for Radiopaedia
        function exportCase(format) {
            const age = document.getElementById('patientAge').value;
            const roundedAge = age >= 18 ? Math.round(age / 5) * 5 : age;
            
            const caseData = {
                title: toSentenceCase(document.getElementById('caseTitle').value),
                demographics: `${roundedAge || '?'} year old ${document.getElementById('patientSex').value || '?'}`,
                presentation: document.getElementById('presentation').value,
                findings: document.getElementById('findings').value,
                discussion: document.getElementById('discussion').value,
                certainty: document.getElementById('certainty').value
            };
            
            if (format === 'radiopaedia') {
                const radiopaediaFormat = `
TITLE (sentence case):
${caseData.title}

DEMOGRAPHICS:
Age: ${roundedAge || 'Not specified'}
Sex: ${document.getElementById('patientSex').value || 'Not specified'}

PATIENT PRESENTATION:
${caseData.presentation}

FINDINGS:
${caseData.findings}

DISCUSSION:
${caseData.discussion}

DIAGNOSTIC CERTAINTY: ${caseData.certainty || 'Not specified'}

---
Compliant with Radiopaedia Style Guide
                `.trim();
                
                navigator.clipboard.writeText(radiopaediaFormat);
                alert('Case formatted per Radiopaedia style guide and copied to clipboard!');
            }
        }
    </script>
</body>
</html>
